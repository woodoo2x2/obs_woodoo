

Для обеспечения целостности хранимых в таблице данных используются **ограничения**. Ограничение представляет собой ключевое слово (или связку ключевых слов), которое указывается в определении поля и добавляет этому полю дополнительные свойства.

### Непустые значения

Ограничение `NOT NULL` используется для того, чтобы запретить полю хранить значение `NULL`. Если поле имеет ограничение `NOT NULL`, это значит, что при добавлении новой записи или обновлении существующей записи значение этого поля не должно быть равным `NULL`.

В качестве примера расширим определение предложенной в начале урока таблицы `Books` и применим ограничение `NOT NULL` к ее полю `id`. Тогда запрос, создающий таблицу, будет выглядеть следующим образом:

```sql
​CREATE TABLE Books
(
    id     INT NOT NULL,
    title  VARCHAR(40),
    author VARCHAR(40)
);
```

Теперь при попытке добавить в таблицу `Books` запись, значение поля `id` которой равняется `NULL`, произойдет ошибка.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT NOT NULL,
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (NULL, 'Fight Club', 'Chuck Palahniuk');
```

является ошибка:

```no-highlight
ERROR 1048: Column 'id' cannot be null
```

Аналогичное поведение будет наблюдаться при попытке изменить значение поля `id` уже имеющейся записи на `NULL`.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT NOT NULL,
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (1, 'Fight Club', 'Chuck Palahniuk');

UPDATE Books
SET id = NULL;
```

является ошибка:

```no-highlight
ERROR 1048: Column 'id' cannot be null
```

В данном примере в таблицу успешно добавляется запись, однако операция обновления этой записи приводит к ошибке, поскольку происходит попытка изменить значение ее поля `id` с допустимого (`1`) на недопустимое (`NULL`).

Если ограничение `NOT NULL` не применяется к полю, то оно может хранить значение `NULL`, то есть хранение `NULL` — поведение по умолчанию.

### Уникальные значения

Ограничение `UNIQUE` используется для того, чтобы запретить полю хранить повторяющиеся значения. Если поле имеет ограничение `UNIQUE`, это значит, что при добавлении новой записи или обновлении существующей записи значение этого поля должно быть уникальным.

В качестве примера расширим определение предложенной в начале урока таблицы `Books` и применим ограничение `UNIQUE` к ее полю `id`. Тогда запрос, создающий таблицу, будет выглядеть следующим образом:

```sql
CREATE TABLE Books
(
    id     INT UNIQUE,
    title  VARCHAR(40),
    author VARCHAR(40)
);
```

Теперь при попытке добавить в таблицу `Books` запись, значение поля `id` которой не является уникальным в рамках этого поля, произойдет ошибка.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT UNIQUE,
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (1, 'Fight Club', 'Chuck Palahniuk'),
       (1, 'The Green Mile', 'Stephen King');
```

является ошибка:

```no-highlight
ERROR 1062: Duplicate entry '1' for key 'Books.id'
```

В данном примере в таблицу успешно добавляется первая запись, однако при попытке добавить вторую запись происходит ошибка, поскольку значение ее поля `id` совпадает со значением поля `id` уже имеющейся в таблице записи.

Аналогичное поведение будет наблюдаться при попытке изменить значение поля `id` на значение, которое не является уникальным в рамках этого поля.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT UNIQUE,
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (1, 'Fight Club', 'Chuck Palahniuk'),
       (2, 'The Green Mile', 'Stephen King');
    
UPDATE Books
SET id = 1
WHERE id = 2;
```

является ошибка:

```no-highlight
ERROR 1062: Duplicate entry '1' for key 'Books.id'
```

В данном примере в таблицу успешно добавляются обе записи, однако операция обновления второй записи приводит к ошибке, поскольку происходит попытка изменить значение ее поля `id` с уникального (`2`) на неуникальное (`1`).

### Значение по умолчанию

Ограничение `DEFAULT` используется для того, чтобы определить значение по умолчанию, которое примет поле в том случае, если при добавлении записи его значение не будет указано явно.

  Если поле имеет значение по умолчанию, тип этого значения должен соответствовать типу самого поля.

В качестве примера расширим определение предложенной в начале урока таблицы `Books` и применим ограничение `DEFAULT` к ее полям `title` и `author`. Тогда запрос, создающий таблицу, будет выглядеть следующим образом:

```sql
CREATE TABLE Books
(
    id     INT,
    title  VARCHAR(40) DEFAULT 'Untitled',
    author VARCHAR(40) DEFAULT 'Unknown'
);
```

Теперь, если при добавлении записи в таблицу `Books` поля `title` и `author` будут опущены, они автоматически примут строковые значения `Untitled` и `Unknown` соответственно.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT,
    title  VARCHAR(40) DEFAULT 'Untitled',
    author VARCHAR(40) DEFAULT 'Unknown'
);

INSERT INTO Books (id)
VALUES (1);

SELECT *
FROM Books;
```

является:

```no-highlight
+----+----------+---------+
| id | title    | author  |
+----+----------+---------+
| 1  | Untitled | Unknown |
+----+----------+---------+
```

Значение по умолчанию, указанное после ключевого слова `DEFAULT`, может быть как константой, так и произвольной сложности выражением с использованием функций и арифметических операторов. Если в качестве значения по умолчанию используется выражение, оно должно быть заключено в круглые скобки. Также выражение, используемое в качестве значения по умолчанию, может ссылаться на значения других полей записи, однако только в том случае, если эти значения уже определены.

В качестве примера вновь расширим определение предложенной в начале урока таблицы `Books` и добавим ей дополнительное поле `fulltitle`, которое будет хранить полное название книги с указанием автора. Значение по умолчанию этого поля определим как конкатенацию значений полей `title` и `author`. Тогда запрос, создающий таблицу, будет выглядеть следующим образом:

```sql
CREATE TABLE Books
(
    id        INT,
    title     VARCHAR(40),
    author    VARCHAR(40),
    fulltitle VARCHAR(40) DEFAULT (CONCAT(title, ' by ', author))
);
```

Теперь, если при добавлении записи в таблицу `Books` поле `fulltitle` будет опущено, его значение все равно будет корректно определено на основе значений полей `title` и `author`.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id        INT,
    title     VARCHAR(40),
    author    VARCHAR(40),
    fulltitle VARCHAR(40) DEFAULT (CONCAT(title, ' by ', author))
);

INSERT INTO Books (id, title, author)
VALUES (1, 'Fight Club', 'Chuck Palahniuk');

SELECT *
FROM Books;
```

является:

```no-highlight
+----+------------+-----------------+-------------------------------+
| id | title      | author          | fulltitle                     |
+----+------------+-----------------+-------------------------------+
| 1  | Fight Club | Chuck Palahniuk | Fight Club by Chuck Palahniuk |
+----+------------+-----------------+-------------------------------+
```

Использование запросов в качестве значений по умолчанию недопустимо.

### Дополнительные проверки

Ограничение `CHECK` используется для того, чтобы запретить полю хранить значения, не удовлетворяющие заданному условию. Если поле имеет ограничение `CHECK`, это значит, что при добавлении новой записи или обновлении существующей записи значение этого поля перед установкой будет проверено на корректность.

Условие, используемое для проверки, представляет собой выражение, заключенное в круглые скобки, которое указывается после ключевого слова `CHECK`. Оно может быть составлено с использованием функций и различных операторов сравнения (`=, >, LIKE` и так далее), то есть иметь произвольную сложность.

В качестве примера расширим определение предложенной в начале урока таблицы `Books` и применим ограничение `CHECK` к ее полю `id`. Тогда запрос, создающий таблицу, будет выглядеть следующим образом:

```sql
CREATE TABLE Books
(
    id     INT CHECK (id > 0),
    title  VARCHAR(40),
    author VARCHAR(40)
);
```

Теперь при попытке добавить в таблицу `Books` запись, значение поля `id` которой не является положительным числом, произойдет ошибка.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT CHECK (id > 0),
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (-3, 'Fight Club', 'Chuck Palahniuk');
```

является ошибка:

```no-highlight
ERROR 3819: Check constraint 'Books_chk_1' is violated.
```

Аналогичное поведение будет наблюдаться при попытке изменить значение поля `id` уже имеющейся записи на неположительное число.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT CHECK (id > 0),
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (1, 'Fight Club', 'Chuck Palahniuk');
    
UPDATE Books
SET id = 0;
```

является ошибка:

```no-highlight
ERROR 3819: Check constraint 'Books_chk_1' is violated.
```

 Ограничение `CHECK` может ссылаться только на значение того поля, для которого применяется.

### Комбинирование ограничений

При использовании ограничений их можно комбинировать. Например, к полю `id` таблицы `Books` мы можем одновременно применить два ограничения `UNIQUE` и `NOT NULL`, чтобы разрешить данному полю хранить лишь непустые уникальные значения.

Запрос, создающий таблицу с подобными ограничениями, выглядит следующим образом:

```sql
​​CREATE TABLE Books
(
    id     INT NOT NULL UNIQUE,
    title  VARCHAR(40),
    author VARCHAR(40)
);
```

Обратите внимание, что перечисление ограничений происходит через пробел, а не через запятую.

У каждого ограничения `CHECK` имеется свое имя, которое СУБД автоматически определяет следующим образом:

```no-highlight
<название таблицы>_chk_<порядковый нормер ограничения>
```

Например, первое определенное в таблице `Books` ограничение будет иметь имя `Books_chk_1`, второе — `Books_chk_2`, и так далее.

Если во время выполнения запроса какое-либо ограничение `CHECK` приводит к ошибке, то его имя отображается в поясняющем сообщении.

Результатом приведенного ниже запроса:

```
CREATE TABLE Books
(
    id     INT CHECK (id > 0),
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title, author)
VALUES (-1, 'Fight Club', 'Chuck Palahniuk');
```

является ошибка:

```no-highlight
ERROR 3819: Check constraint 'Books_chk_1' is violated.
```

Для удобства ограничения `CHECK` можно именовать вручную. Для этого необходимо вынести определение ограничения из определения поля и воспользоваться ключевым словом `CONSTRAINT`.

Результатом приведенного ниже запроса:

```
CREATE TABLE Books
(
    id     INT,
    title  VARCHAR(40),
    author VARCHAR(40),
    CONSTRAINT positive_id CHECK (id > 0)
);

INSERT INTO Books (id, title, author)
VALUES (-1, 'Fight Club', 'Chuck Palahniuk');
```

является ошибка:

```no-highlight
ERROR 3819: Check constraint 'positive_id' is violated.
```

В примере выше определяется ограничение `CHECK` с именем `positive_id` для поля `id` , которое проверяет, что значением этого поля является положительное число. Определение ограничения выполняется отдельно от определения поля. Оно начинается с ключевого слова `CONSTRAINT`, после которого следует имя ограничения, затем ключевое слово `CHECK` и непосредственно проверяющее выражение.

Если поле не имеет явно определенного значения по умолчанию, но поддерживает значение `NULL`, значением по умолчанию такого поля будет `NULL`.

Результатом приведенного ниже запроса:

```sql
CREATE TABLE Books
(
    id     INT,
    title  VARCHAR(40),
    author VARCHAR(40)
);

INSERT INTO Books (id, title)
VALUES (1, 'Fight Club');

SELECT *
FROM Books;
```

является:

```no-highlight
+----+------------+--------+
| id | title      | author |
+----+------------+--------+
| 1  | Fight Club | NULL   |
+----+------------+--------+
```

В данном примере при добавлении записи в таблицу `Books` опускается поле `author`, однако, несмотря на то, что данное поле не имеет значения по умолчанию, запись добавляется без ошибок, а в качестве значения поля `author` используется `NULL`.