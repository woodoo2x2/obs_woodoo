
Функция `DENSE_RANK()` вычисляет ранг записи в рамках указанного окна. Функция требует, чтобы окно, к которому она применяется, было упорядочено, поскольку значение поля (или нескольких полей), по которому было выполнено упорядочивание, будет использоваться для вычисления ранга записи.

Непосредственно вычисление ранга выполняется следующим образом: функция `DENSE_RANK()` присваивает первой записи окна ранг, равный `1`, и увеличивает его каждый раз, когда очередная запись в поле (или полях) упорядочивания содержит значение, отличное от значения предыдущей записи в том же поле.

В качестве примера использования функции `DENSE_RANK()` напишем запрос, который составляет рейтинг сотрудников на основе их зарплаты, располагая сотрудников с равными зарплатами на равных позициях в рейтинге.

Результатом приведенного ниже запроса:

```sql
SELECT full_name, salary,
       DENSE_RANK() OVER (ORDER BY salary DESC) AS place
FROM Employees;
```

является:

```no-highlight
+-----------------+--------+-------+
| full_name       | salary | place |
+-----------------+--------+-------+
| Sundar Pichai   | 11000  | 1     |
| Sergey Brin     | 10000  | 2     |
| John Doerr      | 10000  | 2     |
| Alice Johnson   | 10000  | 2     |
| Marissa Mayer   | 9000   | 3     |
| Sheryl Sandberg | 9000   | 3     |
| Eric Schmidt    | 8000   | 4     |
| Susan Wojcicki  | 8000   | 4     |
| Larry Page      | 7000   | 5     |
| John Smith      | 7000   | 5     |
+-----------------+--------+-------+
```

Здесь функция `DENSE_RANK()` выполняет ранжирование на основе поля `salary`: если значение записи в этом поле изменяется, то ранг увеличивается, в противном случае ранг сохраняет текущее значение.

Аналогичный рейтинг можно составить не среди всех сотрудников, а лишь в рамках определенного отдела. Для этого достаточно разбить используемое окно на соответствующие секции.

Результатом приведенного ниже запроса:

```sql
SELECT full_name, department, salary,
       DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS place
FROM Employees;
```

является:

```no-highlight
+-----------------+-------------+--------+-------+
| full_name       | department  | salary | place |
+-----------------+-------------+--------+-------+
| Sergey Brin     | Engineering | 10000  | 1     |
| Alice Johnson   | Engineering | 10000  | 1     |
| Susan Wojcicki  | Engineering | 8000   | 2     |
| Larry Page      | Engineering | 7000   | 3     |
| John Smith      | Engineering | 7000   | 3     |
| Marissa Mayer   | Marketing   | 9000   | 1     |
| Sheryl Sandberg | Marketing   | 9000   | 1     |
| Eric Schmidt    | Marketing   | 8000   | 2     |
| Sundar Pichai   | Sales       | 11000  | 1     |
| John Doerr      | Sales       | 10000  | 2     |
+-----------------+-------------+--------+-------+
```

Поведение функции `RANK()` похоже на поведение функции `DENSE_RANK()`, поэтому разницу между ними проще всего показать на сравнительном примере.

Результатом приведенного ниже запроса:

```sql
SELECT full_name, salary,
       DENSE_RANK() OVER salary_desc AS row_dense_rank,
       RANK() OVER salary_desc AS row_rank
FROM Employees
WINDOW salary_desc AS (ORDER BY salary DESC);
```

является:

```no-highlight
+-----------------+--------+----------------+----------+
| full_name       | salary | row_dense_rank | row_rank |
+-----------------+--------+----------------+----------+
| Sundar Pichai   | 11000  | 1              | 1        |
| Sergey Brin     | 10000  | 2              | 2        |
| John Doerr      | 10000  | 2              | 2        |
| Alice Johnson   | 10000  | 2              | 2        |
| Marissa Mayer   | 9000   | 3              | 5        |
| Sheryl Sandberg | 9000   | 3              | 5        |
| Eric Schmidt    | 8000   | 4              | 7        |
| Susan Wojcicki  | 8000   | 4              | 7        |
| Larry Page      | 7000   | 5              | 9        |
| John Smith      | 7000   | 5              | 9        |
+-----------------+--------+----------------+----------+
```

Здесь функции `DENSE_RANK()` и `RANK()` применяются к одному и тому же окну `salary_desc`. Видно, что функция `DENSE_RANK()` выполняет ранжирование без пропусков, в то время как функция `RANK()` при повторении рангов следующий ранг отбрасывает.
#sql 