

Определить границы окна можно с помощью оператора `ROWS`, синтаксис использования которого имеет следующий вид:

```css
ROWS BETWEEN <начальная граничная точка> AND <конечная граничная точка>
```

Начальная граничная точка может быть представлена одним из следующих значений:

- `CURRENT ROW` — текущая запись
- `n PRECEDING` — `n`-ая запись перед текущей
- `n FOLLOWING` — `n`-ая запись после текущей
- `UNBOUNDED PRECEDING` — самая первая запись окна (или секции окна, если было применено секционирование)

Конечная граничная точка может быть представлена одним из следующих значений:

- `CURRENT ROW` — текущая запись
- `n PRECEDING` — `n`-ая запись перед текущей
- `n FOLLOWING` — `n`-ая запись после текущей
- `UNBOUNDED FOLLOWING` — самая последняя запись окна (или секции окна, если было применено секционирование)

Oператор `ROWS` в определении окна должен располагаться после операторов `PARTITION BY` и `ORDER BY`.
### Примеры определения границ окна с помощью оператора ROWS

Для большего понимания рассмотрим несколько примеров определения оконных границ. Все границы будем определять относительно окна (не разбитого на секции), которое имеет следующий вид:

```no-highlight
+----+-----------------+-------------+--------+
| id | full_name       | department  | salary |
+----+-----------------+-------------+--------+
| 1  | Sergey Brin     | Engineering | 10000  |
| 2  | John Doerr      | Sales       | 10000  |
| 3  | Larry Page      | Engineering | 7000   |
| 4  | Eric Schmidt    | Marketing   | 8000   |
| 5  | Sundar Pichai   | Sales       | 11000  |
+----+-----------------+-------------+--------+
```

**Пример 1.** Определим границы окна, взяв в качестве начальной граничной точки предыдущую запись, а в качестве конечной — следующую:

```css
​ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
```

**Пример 2.** Определим границы окна, взяв в качестве начальной граничной точки самую первую запись окна, а в качестве конечной — текущую:

```css
​ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
```

Тогда применяемая к окну оконная функция во время работы, например, с третьей записью (`id = 3`) будет выполнять вычисления лишь в рамках следующей части окна:

```no-highlight
+----+-----------------+-------------+--------+
| id | full_name       | department  | salary |
+----+-----------------+-------------+--------+
| 1  | Sergey Brin     | Engineering | 10000  | ┐
| 2  | John Doerr      | Sales       | 10000  | │
| 3  | Larry Page      | Engineering | 7000   | ┘    <-- текущая запись
| 4  | Eric Schmidt    | Marketing   | 8000   |
| 5  | Sundar Pichai   | Sales       | 11000  |
+----+-----------------+-------------+--------+
```

если с четвертой (`id = 4`) — в рамках следующей части окна:

```no-highlight
+----+-----------------+-------------+--------+
| id | full_name       | department  | salary |
+----+-----------------+-------------+--------+
| 1  | Sergey Brin     | Engineering | 10000  | ┐
| 2  | John Doerr      | Sales       | 10000  | │
| 3  | Larry Page      | Engineering | 7000   | │
| 4  | Eric Schmidt    | Marketing   | 8000   | ┘   <-- текущая запись
| 5  | Sundar Pichai   | Sales       | 11000  |
+----+-----------------+-------------+--------+
```

**Пример 3.** Определим границы окна, взяв в качестве начальной граничной точки следующую запись, а в качестве конечной — следующую за следующей:

```css
​ROWS BETWEEN 1 FOLLOWING AND 2 FOLLOWING
```

Тогда применяемая к окну оконная функция во время работы, например, со второй записью (`id = 2`) будет выполнять вычисления лишь в рамках следующей части окна:

```no-highlight
+----+-----------------+-------------+--------+
| id | full_name       | department  | salary |
+----+-----------------+-------------+--------+
| 1  | Sergey Brin     | Engineering | 10000  |
| 2  | John Doerr      | Sales       | 10000  |      <-- текущая запись
| 3  | Larry Page      | Engineering | 7000   | ┐    <-- следующая запись
| 4  | Eric Schmidt    | Marketing   | 8000   | ┘    <-- запись, следующая за следующей
| 5  | Sundar Pichai   | Sales       | 11000  |
+----+-----------------+-------------+--------+
```

если с третьей (`id = 3`) — в рамках следующей части окна:

```no-highlight
+----+-----------------+-------------+--------+
| id | full_name       | department  | salary |
+----+-----------------+-------------+--------+
| 1  | Sergey Brin     | Engineering | 10000  |
| 2  | John Doerr      | Sales       | 10000  |
| 3  | Larry Page      | Engineering | 7000   |      <-- текущая запись 
| 4  | Eric Schmidt    | Marketing   | 8000   | ┐    <-- следующая запись
| 5  | Sundar Pichai   | Sales       | 11000  | ┘    <-- запись, следующая за следующей
+----+-----------------+-------------+--------+
```

### Примеры использования оператора ROWS

В качестве примера использования оконных границ, определенных с помощью оператора `ROWS`, напишем запрос, который вычисляет среднюю зарплату каждого сотрудника, учитывая только зарплату самого сотрудника, а также зарплаты сотрудников с меньшим идентификатором.

Результатом приведенного ниже запроса:

```sql
SELECT id, full_name, salary,
       AVG(salary) OVER (ORDER BY id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS avg_salary
FROM Employees;
```

является:

```no-highlight
+----+-----------------+--------+------------+
| id | full_name       | salary | avg_salary |
+----+-----------------+--------+------------+
| 1  | Sergey Brin     | 10000  | 10000.0000 |
| 2  | John Doerr      | 10000  | 10000.0000 |
| 3  | Larry Page      | 7000   | 9000.0000  |
| 4  | Eric Schmidt    | 8000   | 8750.0000  |
| 5  | Sundar Pichai   | 11000  | 9200.0000  |
| 6  | Marissa Mayer   | 9000   | 9166.6667  |
| 7  | Susan Wojcicki  | 8000   | 9000.0000  |
| 8  | John Smith      | 7000   | 8750.0000  |
| 9  | Sheryl Sandberg | 9000   | 8777.7778  |
| 10 | Alice Johnson   | 10000  | 8900.0000  |
+----+-----------------+--------+------------+
```

В примере выше определено окно, записи в котором расположены в порядке возрастания значения поля `id`. Более того, у окна указаны границы: начальной граничной точкой является самая первая запись окна, конечной — текущая.

Таким образом, применяемая к окну оконная функция `AVG()` при вычислении среднего значения поля `salary` для очередной записи использует значение текущей записи, а также всех предыдущих. Например, для второй записи среднее значение вычисляется как `(10000 + 10000) / 2`, для третьей — `(10000 + 10000 + 7000) / 3`, для четвертой — `(10000 + 10000 + 7000 + 8000) / 4`, и так далее.

Во время использования оконных границ важно, чтобы окно было упорядочено, поскольку для точного результата все предыдущие и следующие записи относительно текущей должны определяться однозначно.

В качестве дополнительного примера напишем запрос, который вычисляет среднюю зарплату каждого сотрудника, учитывая только зарплату самого сотрудника, а также зарплаты его коллег по отделу с меньшим идентификатором.

Результатом приведенного ниже запроса:

```sql
SELECT id, full_name, department, salary,
       AVG(salary) OVER (PARTITION BY department
                         ORDER BY id
                         ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS avg_salary
FROM Employees;
```

является:

```no-highlight
+----+-----------------+-------------+--------+------------+
| id | full_name       | department  | salary | avg_salary |
+----+-----------------+-------------+--------+------------+
| 1  | Sergey Brin     | Engineering | 10000  | 10000.0000 |
| 3  | Larry Page      | Engineering | 7000   | 8500.0000  |
| 7  | Susan Wojcicki  | Engineering | 8000   | 8333.3333  |
| 8  | John Smith      | Engineering | 7000   | 8000.0000  |
| 10 | Alice Johnson   | Engineering | 10000  | 8400.0000  |
| 4  | Eric Schmidt    | Marketing   | 8000   | 8000.0000  |
| 6  | Marissa Mayer   | Marketing   | 9000   | 8500.0000  |
| 9  | Sheryl Sandberg | Marketing   | 9000   | 8666.6667  |
| 2  | John Doerr      | Sales       | 10000  | 10000.0000 |
| 5  | Sundar Pichai   | Sales       | 11000  | 10500.0000 |
+----+-----------------+-------------+--------+------------+
```
