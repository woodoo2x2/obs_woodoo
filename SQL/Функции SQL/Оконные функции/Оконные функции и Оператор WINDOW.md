Важным термином в изучении оконных функций является **результирующий набор**. Он представляет собой таблицу, которая формируется извлекающим запросом в результате выполнения следующих операций (некоторые являются опциональными): соединение (`JOIN`), извлечение (`FROM`), фильтрация (`WHERE`), группировка (`GROUP BY`) и фильтрация групп (`HAVING`).

Например, результирующим набором приведенного ниже запроса:

```sql
SELECT full_name AS engineer
FROM Employees
WHERE department = 'Engineering'
LIMIT 3;
```

является:

```no-highlight
+----+----------------+-------------+--------+
| id | full_name      | department  | salary |
+----+----------------+-------------+--------+
| 1  | Sergey Brin    | Engineering | 10000  |
| 3  | Larry Page     | Engineering | 7000   |
| 7  | Susan Wojcicki | Engineering | 8000   |
| 8  | John Smith     | Engineering | 7000   |
| 10 | Alice Johnson  | Engineering | 10000  |
+----+----------------+-------------+--------+
```

Обратите внимание, что результирующий набор и результат запроса — это не одно и то же. Результат запроса формируется на основе результирующего набора в результате выполнения следующих операций (некоторые являются опциональными): выборка (`SELECT`), присвоение псевдонимов (`AS`), сортировка (`ORDER BY`) и ограничение количества записей (`LIMIT`).

 Записи в результирующем наборе могут располагаться **в** **произвольном порядке**.



**Оконная функция** — это функция, которая выполняет вычисления на основе определенного набора записей и возвращает одиночное значение. Набор записей, с которым работает оконная функция, называют **окном**. По умолчанию содержимое окна полностью совпадает с результирующим набором запроса, в рамках которого определено окно.

Определение окна выполняется с помощью оператора `WINDOW`, синтаксис использования которого имеет следующий вид:

```css
WINDOW <название окна> AS (<спецификация окна>)
```

Определение окна в рамках запроса выполняется после группировки (или фильтрации групп) и до сортировки, поэтому оператор `WINDOW` в запросе располагается после оператора `GROUP BY` (или `HAVING`) и до оператора `ORDER BY`.

Спецификация окна, заключаемая в круглые скобки, может включать три базовых элемента: **секционирование** (разбиение на секции), **упорядочивание** и **определение границ окна**. Подробнее элементы спецификации мы рассмотрим позже, а пока лишь отметим, что если ни один из них не указан, то содержимое окна будет сформировано по умолчанию.

Например, в рамках приведенного ниже запроса:

```sql
SELECT full_name AS engineer
FROM Employees
WHERE department = 'Engineering'
WINDOW all_rows AS ()
LIMIT 3;
```

определяется окно с именем `all_rows`, содержимое которого имеет следующий вид:

```no-highlight
+----+----------------+-------------+--------+
| id | full_name      | department  | salary |
+----+----------------+-------------+--------+
| 1  | Sergey Brin    | Engineering | 10000  |
| 3  | Larry Page     | Engineering | 7000   |
| 7  | Susan Wojcicki | Engineering | 8000   |
| 8  | John Smith     | Engineering | 7000   |
| 10 | Alice Johnson  | Engineering | 10000  |
+----+----------------+-------------+--------+
```

Окно существует независимо от результирующего набора и всего лишь определяет свое содержимое на его основе.
Оконные функции обычно подразделяют на три основные группы: [[Функция ROW_NUMBER|Ранжирующие функции]], [[Оконные агрегатные функции]] и [[Функции смещения]].

Определить окно можно без использования оператора `WINDOW`. Для этого достаточно предоставить спецификацию окна, заключенную в круглые скобки, сразу после ключевого слова `OVER`.

Результатом приведенного ниже запроса:

```sql
SELECT full_name, salary,
       ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num
FROM Employees;
```

является:

```no-highlight
+-----------------+--------+---------+
| full_name       | salary | row_num |
+-----------------+--------+---------+
| Sundar Pichai   | 11000  | 1       |
| Sergey Brin     | 10000  | 2       |
| John Doerr      | 10000  | 3       |
| Alice Johnson   | 10000  | 4       |
| Marissa Mayer   | 9000   | 5       |
| Sheryl Sandberg | 9000   | 6       |
| Eric Schmidt    | 8000   | 7       |
| Susan Wojcicki  | 8000   | 8       |
| Larry Page      | 7000   | 9       |
| John Smith      | 7000   | 10      |
+-----------------+--------+---------+
```
Как было упомянуто ранее, сортировка записей внутри окна не влияет на их расположение в результирующем наборе. Поэтому при необходимости гарантировать некий порядок записей в результате запроса, его необходимо определить явно в рамках самого запроса.

Результатом приведенного ниже запроса:

```sql
SELECT full_name, salary,
       ROW_NUMBER() OVER salary_desc AS row_num 
FROM Employees
WINDOW salary_desc AS (ORDER BY salary DESC)       -- определяем порядок записей в окне
ORDER BY salary, row_num DESC;                     -- определяем порядок записей в результате запроса
```

является:

```no-highlight
+-----------------+--------+---------+
| full_name       | salary | row_num |
+-----------------+--------+---------+
| John Smith      | 7000   | 10      |
| Larry Page      | 7000   | 9       |
| Susan Wojcicki  | 8000   | 8       |
| Eric Schmidt    | 8000   | 7       |
| Sheryl Sandberg | 9000   | 6       |
| Marissa Mayer   | 9000   | 5       |
| Alice Johnson   | 10000  | 4       |
| John Doerr      | 10000  | 3       |
| Sergey Brin     | 10000  | 2       |
| Sundar Pichai   | 11000  | 1       |
+-----------------+--------+---------+
```
Разбиение окна на секции с помощью оператора `PARTITION BY` выполняется **без учета регистра**. Например, если условное поле `field`, по которому происходит секционирование, содержит строковые значения `Value` и `value`, то записи с такими значениями попадут в одну секцию. Стоит заметить, что группировка с помощью оператора `GROUP BY` также является **регистронезависимой**.

Всегда необходимо помнить, в какой именно момент происходит определение окна: после выполнения операций соединения (`JOIN`), извлечения (`FROM`), фильтрации (`WHERE`), группировки (`GROUP BY`) и фильтрации групп (`HAVING`).

Результатом приведенного ниже запроса:

```sql
SELECT salary,
       ROW_NUMBER() OVER () AS row_num             -- используемое окно определяется после выполнения группировки
FROM Employees
GROUP BY salary;
```

является:

```no-highlight
+--------+---------+
| salary | row_num |
+--------+---------+
| 10000  | 1       |
| 7000   | 2       |
| 8000   | 3       |
| 11000  | 4       |
| 9000   | 5       |
+--------+---------+
```

С помощью оператора `WINDOW` можно определить как одно окно, так и несколько. Во втором случае достаточно перечислить определения всех окон через запятую.

Например, в рамках приведенного ниже запроса:

```sql
SELECT full_name, salary
FROM Employees
WHERE department = 'Engineering'
WINDOW salary_asc AS (ORDER BY salary),
       salary_desc AS (ORDER BY salary DESC)
```

определяется окно с именем `salary_asc`, содержимое которого имеет следующий вид:

```no-highlight
+----+----------------+-------------+--------+
| id | full_name      | department  | salary |
+----+----------------+-------------+--------+
| 3  | Larry Page     | Engineering | 7000   |
| 8  | John Smith     | Engineering | 7000   |
| 7  | Susan Wojcicki | Engineering | 8000   |
| 1  | Sergey Brin    | Engineering | 10000  |
| 10 | Alice Johnson  | Engineering | 10000  |
+----+----------------+-------------+--------+
```

а также окно с именем `salary_desc`, содержимое которого имеет следующий вид:

```no-highlight
+----+----------------+-------------+--------+
| id | full_name      | department  | salary |
+----+----------------+-------------+--------+
| 1  | Sergey Brin    | Engineering | 10000  |
| 10 | Alice Johnson  | Engineering | 10000  |
| 7  | Susan Wojcicki | Engineering | 8000   |
| 3  | Larry Page     | Engineering | 7000   |
| 8  | John Smith     | Engineering | 7000   |
+----+----------------+-------------+--------+
```
#sql 