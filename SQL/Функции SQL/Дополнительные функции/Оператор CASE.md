[[Функция IF()]] позволяет выбрать одно из двух значений в зависимости от того, истинно определенное условие или нет. Она достаточно удобна, однако не подходит для построения каких-либо сложных условных конструкций, поскольку ограничена лишь двумя потенциальными значениями и единственным условием. Для решения задач, в которых необходимо выполнить проверку нескольких условий и в зависимости от истинности одного из них вернуть соответствующее значение, используется оператор `CASE`.



### Простая форма

Оператор `CASE` поддерживает две формы записи: простую и усложненную. Простая форма имеет следующий синтаксис:

```
CASE <значение>
    WHEN <первое сравниваемое значение> THEN <результат>
    WHEN <второе сравниваемое значение> THEN <результат>
    ...
    WHEN <n-oe сравниваемое значение> THEN <результат>
    ELSE <значение по умолчанию>
END
```

Простая форма подразумевает, что после оператора `CASE` указывается некоторое значение, которое последовательно сравнивается на равенство с другими значениями. Каждое сравниваемое значение указывается после ключевого слова `WHEN`, а результат, который будет возвращен, если исходное значение и сравниваемое окажутся равными, — после ключевого слова `THEN`. Если исходное значение не совпадет ни с одним из сравниваемых значений, результатом будет значение по умолчанию, которое указывается после ключевого слова `ELSE`.

Ключевое слово `ELSE` может быть опущено, в таком случае значением по умолчанию считается `NULL`.

Условная конструкция с оператором `CASE` может использоваться как для преобразования значения для дальнейшего его использования, так и для последующего извлечения. Если возвращаемое оператором `CASE` значение предполагается отображать в результирующей таблице, то в таком случае полю с этим значением можно дать псевдоним, который необходимо указать после ключевого слова `END`.

```
    ...
    WHEN <n-oe сравниваемое значение> THEN <результат>
    ELSE <значение по умолчанию>
END AS <псевдоним>
```

В качестве примера использования простой формы оператора `CASE` напишем запрос, который извлекает информацию о книгах и сообщает об их доступном для покупки количестве.

Результатом приведенного ниже запроса:

```sql
SELECT title, author,
       CASE quantity
           WHEN 0 THEN 'Out of stock'
           WHEN 1 THEN 'One in stock'
           WHEN 2 THEN 'Little in stock'
           WHEN 3 THEN 'Little in stock'
           WHEN 4 THEN 'Little in stock'
           WHEN 5 THEN 'Little in stock'
           ELSE 'A lot in stock'
       END AS availability
FROM Books;
```

является:

```no-highlight
+------------------------+---------------------+-----------------+
| title                  | author              | availability    |
+------------------------+---------------------+-----------------+
| Fight Club             | Chuck Palahniuk     | A lot in stock  |
| The Catcher in the Rye | J.D. Salinger       | One in stock    |
| The Green Mile         | Stephen King        | Little in stock |
| The Great Gatsby       | F. Scott Fitzgerald | Little in stock |
| The Lord of the Rings  | J.R.R. Tolkien      | Out of stock    |
+------------------------+---------------------+-----------------+
```

В запросе выше числовые значения поля `quantity` преобразуются в соответствующие им строковые значения путем последовательных сравнений. Значение поля `quantity`, попадая в условную конструкцию, сравнивается с числами от `0` до `5`, пока не будет найдено совпадение с одним из них. Например, для значения `0` результатом будет строка `Out of stock`, для значения `3` — строка `Little in stock`. Для значений больше `5` результатом будет значение по умолчанию — строка `A lot in stock`, поскольку для такого числа гарантированно не будет найдено ни одно совпадение.

### **Усложненная форма**

Усложненная форма оператора `CASE` имеет следующий синтаксис:

```
CASE
    WHEN <первое условие> THEN <результат>
    WHEN <второе условие> THEN <результат>
    ...
    WHEN <n-oe условие> THEN <результат>
    ELSE <значение по умолчанию>
END AS <псевдоним>
```

Ключевая разница усложненной формы от простой заключается в том, что она не требует какого-либо значения, которое будет сравниваться с другими. По сути усложненная форма представляет собой набор произвольных условий, которые последовательно проверяются на истинность. Если проверяемое условие истинно, то результатом будет соответствующее ему значение, если ложно — проверка перейдет к следующему условию. Если все условия окажутся ложными, результатом будет значение по умолчанию.

Усложненная форма позволяет писать более гибкие и компактные условные конструкции. В качестве демонстрации преимущества усложненной формы напишем запрос, выполняющий ровно ту же задачу, что выполнял предыдущий запрос с оператором `CASE` в простой форме.

Результатом приведенного ниже запроса:

```sql
SELECT title, author,
       CASE
           WHEN quantity = 0 THEN 'Out of stock'
           WHEN quantity = 1 THEN 'One in stock'
           WHEN quantity BETWEEN 2 AND 5 THEN 'Little in stock'
           ELSE 'A lot in stock'
       END AS availability
FROM Books;
```

является:

```no-highlight
+------------------------+---------------------+-----------------+
| title                  | author              | availability    |
+------------------------+---------------------+-----------------+
| Fight Club             | Chuck Palahniuk     | A lot in stock  |
| The Catcher in the Rye | J.D. Salinger       | One in stock    |
| The Green Mile         | Stephen King        | Little in stock |
| The Great Gatsby       | F. Scott Fitzgerald | Little in stock |
| The Lord of the Rings  | J.R.R. Tolkien      | Out of stock    |
+------------------------+---------------------+-----------------+
```

Запрос выше по-прежнему извлекает поля `title, author` и `availability`, однако для вычисления значений последнего поля оператор `CASE` не привязывается к полю `quantity`, а лишь использует его значения в своих условиях. Так, если значение поля `quantity` равняется `0`, то значением поля `availability` будет строка `Out of stock`, если значение представляет собой число в диапазоне `[2; 5]`, то значением поля `availability` будет строка `Little in stock`. Для значений больше `5` определено значение по умолчанию в виде строки `A lot in stock`.

В качестве дополнительного примера использования усложненной формы оператора `CASE` напишем запрос, который извлекает информацию о книгах и оценивает их стоимость.

Результатом приведенного ниже запроса:

```sql
SELECT title, author,
       CASE
           WHEN price < 5 THEN 'Cheap'
           WHEN price BETWEEN 5 AND 15 THEN 'Regular'
           ELSE 'Expensive'
       END AS rate
FROM Books;
```

является:

```no-highlight
+------------------------+---------------------+-----------+
| title                  | author              | rate      |
+------------------------+---------------------+-----------+
| Fight Club             | Chuck Palahniuk     | Regular   |
| The Catcher in the Rye | J.D. Salinger       | Cheap     |
| The Green Mile         | Stephen King        | Expensive |
| The Great Gatsby       | F. Scott Fitzgerald | Regular   |
| The Lord of the Rings  | J.R.R. Tolkien      | Expensive |
+------------------------+---------------------+-----------+
```

Здесь оператор `CASE` используется для создания поля `rate` с оценкой стоимости книги. Если ее цена меньше `5` долларов, она считается дешевой, если от `5` до `15` — обычной, в остальных случаях книга считается дорогой.

 Оператор `CASE` может рассматриваться как функция, поскольку результатом его выполнения, независимо от формы, всегда является определенное значение. Например, условные конструкции можно использовать в блоках операторов `WHERE` и `ORDER BY`, а также помещать их в различные функции для последующего преобразования результата.

Результатом приведенного ниже запроса:

```sql
SELECT title, author,
       UPPER(CASE
                 WHEN price < 5 THEN 'Cheap'
                 WHEN price BETWEEN 5 AND 15 THEN 'Regular'
                 ELSE 'Expensive'
             END) AS rate
FROM Books;
```

является:

```no-highlight
+------------------------+---------------------+-----------+
| title                  | author              | rate      |
+------------------------+---------------------+-----------+
| Fight Club             | Chuck Palahniuk     | REGULAR   |
| The Catcher in the Rye | J.D. Salinger       | CHEAP     |
| The Green Mile         | Stephen King        | EXPENSIVE |
| The Great Gatsby       | F. Scott Fitzgerald | REGULAR   |
| The Lord of the Rings  | J.R.R. Tolkien      | EXPENSIVE |
+------------------------+---------------------+-----------+
```