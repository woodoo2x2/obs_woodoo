При изучении [[Агрегатные Функции SQL|агрегатных функций]] было замечено, что их нельзя использовать для фильтрации записей, поэтому если мы захотим извлечь данные о книгах, чья стоимость превышает среднюю стоимость всех книг, то сделать это с помощью следующего запроса будет невозможно:

```
SELECT *
FROM Books
WHERE price > AVG(price);
```

поскольку его результатом является ошибка:

```no-highlight
ERROR 1111: Invalid use of group function
```

Для решения данной задачи мы можем воспользоваться подзапросом, чтобы сперва вычислить среднюю стоимость книг, а затем выполнить сравнение с полученным значением.

Результатом приведенного ниже запроса:

```
SELECT *
FROM Books
WHERE price > (SELECT AVG(price)
               FROM Books);
```

является:

```no-highlight
+----+-----------------------+-----------------+-------+
| id | title                 | author          | price |
+----+-----------------------+-----------------+-------+
| 4  | The Green Mile        | Stephen King    | 15.99 |
| 6  | The Lord of the Rings | J.R.R. Tolkien  | 19.99 |
| 7  | It                    | Stephen King    | 12.99 |
| 8  | The Silmarillion      | J.R.R. Tolkien  | 11.99 |
| 9  | Haunted               | Chuck Palahniuk | 13.99 |
+----+-----------------------+-----------------+-------+
```

Здесь в условии фильтрации значение поля `price` сравнивается с результатом подзапроса. Подзапрос обращается к таблице `Books` и вычисляет среднее арифметическое всех значений ее поля `price`. Таблица, получаемая в результате подзапроса, состоит из одной записи и одного поля, то есть содержит единственное значение, с которым и происходит последующее сравнение значения поля `price`.

Сравнение значения поля  `price` с таблицей возможно именно по той причине, что эта таблица содержит лишь одно значение, и СУБД использует это значение для выполнения операции сравнения. Если бы таблица содержала более одного значения, такая операция была бы невозможна.

Результатом приведенного ниже запроса:

```
SELECT *
FROM Books
WHERE price > (SELECT price
               FROM Books);
```

является ошибка:

```no-highlight
ERROR 1242: Subquery returns more than 1 row
```

Подзапросы могут использоваться не только для фильтрации записей, но и для фильтрации групп. Таким примером может быть запрос, извлекающий данные об авторах, средняя стоимость книг которых превышает среднюю стоимость всех книг.

Результатом приведенного ниже запроса:

```sql
SELECT author, AVG(price) AS avg_price
FROM Books
GROUP BY author
HAVING AVG(price) > (SELECT AVG(price)
                     FROM Books);
```

является:

```no-highlight
+-----------------+--------------------+
| author          | avg_price          |
+-----------------+--------------------+
| Stephen King    | 12.323333104451498 |
| Chuck Palahniuk | 11.989999771118164 |
| J.R.R. Tolkien  | 15.989999771118164 |
+-----------------+--------------------+
```

Здесь записи сперва группируются по полю `author`, а затем фильтруются. Для фильтрации используется подзапрос, который, как и выше, обращается к таблице `Books` и вычисляет среднее арифметическое всех значений ее поля `price`. Группа попадает в результирующую таблицу, если среднее значение ее поля `price` больше среднего значения поля `price` всей таблицы, в противном случае группа отбрасывается.

)Подзапросы при фильтрации позволяют вычислять различные значения на основе данных из всей таблицы (минимум, максимум, среднее значение) и использовать их в условиях фильтрации.