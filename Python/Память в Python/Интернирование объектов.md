 ##  Интернирование объектов

Как мы знаем, в Python целые числа (тип `int`) и строки (тип `str`) являются неизменяемыми. Это значит, что после того как строковые и целочисленные объекты были созданы, мы не можем изменить или обновить их. Даже если кажется, что строка изменяется, например, после использования метода, на самом деле создается новая строка, а исходная остается прежней.

Приведенный ниже код:

```python
s1 = 'beegeek'

s2 = s1.lower()
s3 = s1.upper()

print(s1)
```

выводит:

```python
beegeek
```

Учитывая неизменяемость строковых и целочисленных объектов, Python использует специальную оптимизацию, которая называется интернированием. Интернирование – это процесс хранения в памяти только одной копии объекта. Это означает, что, когда мы создаем две строки (два целых числа) с одинаковыми значениями, то вместо выделения памяти для них обоих, только одна строка (целое число) фактически фиксируется в памяти. Другая же просто указывает на то же самое место в памяти. Для реализации данной оптимизации Python использует специальную таблицу, которая называется пул интернирования. Эта таблица содержит одну уникальную ссылку на каждый объект строкового типа, либо целого числа.

### Интернирование целых чисел

Поскольку небольшие целые числа встречаются достаточно часто в нашем коде, Python интернирует их в диапазоне от −5−5 до 256256.

Приведенный ниже код:

```python
num1 = 100
num2 = 100

num3 = 1000
num4 = 1000

print(num1 is num2, num1 == num2)
print(num3 is num4, num3 == num4)
```

выводит:

```no-highlight
True True
False True
```

![](https://ucarecdn.com/804195d8-8300-47ad-8679-74700d6dfc79/)

Важно отметить, что среда, в которой выполняется код, влияет на то, как работает интернирование. Поведение может отличаться при использовании различных IDE (PyCharm, Thonny и т.д.), так как все они имеют собственные уровни оптимизации. Все примеры в данном конспекте, а также в задачах, предполагают, что код выполняется в IDLE Python 3.10.

![](https://ucarecdn.com/73e8b83a-852a-44c3-a179-d500807dbdf6/)IDLE (Integrated Development and Learning Environment) — это интегрированная среда для разработки (и обучения), которая поставляется вместе с Python.

Обратите внимание на то, что независимо от того, каким образом мы создаем целочисленный объект, если он находится в диапазоне от −5−5 до 256256, он будет интернирован.

Приведенный ниже код:

```python
num1 = 100 
num2 = int(100)
num3 = int('100')
num4 = 1 + 2 + 97

print(id(num1))
print(id(num2))
print(id(num3))
print(id(num4))
```

всегда выводит одинаковые числа (числа могут отличаться от запуска к запуску программы):

```no-highlight
1979656244560
1979656244560
1979656244560
1979656244560
```

### Интернирование строк

В Python 3.7 интернируются строки, содержащие не более 2020 символов и состоящие только из ASCII-букв, цифр и знаков подчёркивания. Данный набор символов был выбран потому, что он часто используется в нашем коде.

Приведенный ниже код:

```python
s1 = 'beegeek'
s2 = 'beegeek'
s3 = 'bee' + 'geek'

print(id(s1))
print(id(s2))
print(id(s3))
```

всегда выводит одинаковые числа (числа могут отличаться от запуска к запуску программы):

```no-highlight
2846528331184
2846528331184
2846528331184
```

![](https://ucarecdn.com/4b391b3f-0082-4988-9102-30423d636c20/)

В то время как приведенный ниже код:

```python
s1 = 'beegeek!'
s2 = 'beegeek!'

print(id(s1))
print(id(s2))
```

всегда выводит разные числа (числа могут отличаться от запуска к запуску программы):

```no-highlight
2846528331312
2846528331440
```

![](https://ucarecdn.com/dac78edc-6a23-4195-995b-db8441d62cda/)

В этом примере использован восклицательный знак, поэтому строки не интернируются и представляют собой разные объекты.

Начиная с Python 3.8 длина интернируемых строк была увеличена до 40964096 символов.

Приведенный ниже код:

```python
s1 = 'b' * 4096
s2 = 'b' * 4096

s3 = 'b' * 5000
s4 = 'b' * 5000

print(s1 is s2)
print(s3 is s4)
```

в Python 3.8+ выводит:

```no-highlight
True
False
```

![](https://ucarecdn.com/dc5960b3-8988-4b54-a937-11870c4da109/)

## Функция sys.intern()

Как мы уже знаем, Python интернирует лишь строки, содержащие не более 40964096 символов и состоящие только из ASCII-букв, цифр и знаков подчёркивания. Однако функция `intern()` из модуля `sys` позволяет интернировать любую строку, например, содержащую 50005000 символов или состоящую из букв русского алфавита. Данная функция принимает в качестве аргумента строку, добавляет ее в пул интернирования (если ее там нет) и возвращает интернированную строку.

Приведенный ниже код:

```python
s1 = 'степик!'
s2 = 'степик!'

print(s1 is s2)
```

выводит:

```no-highlight
False
```

В то время как приведенный ниже код:

```python
import sys

s1 = sys.intern('степик!')
s2 = sys.intern('степик!')

print(s1 is s2)
```

выводит:

```no-highlight
True
```

## Примечания

**Примечание 1.** Основные преимущества интернирования:

- **экономия памяти**: мы не храним копии одинаковых объектов
- **быстрые сравнения**: сравнение интернированных строк происходит намного быстрее, чем неинтернированных строк. Это происходит потому, что для сравнения интернированных строк нужно только сравнить, совпадают ли их адреса в памяти, а не сравнивать их содержимое

**Примечание 2.** Интернирование объектов не всегда работает очевидно, поэтому мы всегда можем использовать встроенную функцию `id()` и оператор `is` для определения идентичности объектов.

**Примечание 3.** Прочитать о различных Python оптимизациях можно по [ссылке](https://pyjion.readthedocs.io/en/latest/optimizations.html#optimizations) и [ссылке](https://levelup.gitconnected.com/python-optimizations-a822db1f6bf5).

**Примечание 4.** Исходный код peephole и AST оптимизаторов в Python доступен по [ссылке](https://github.com/akheron/cpython/blob/master/Python/peephole.c) и [ссылке](https://github.com/python/cpython/blob/3.7/Python/ast_opt.c).